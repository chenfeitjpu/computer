**RabbitMQ**
- [定义](#定义)
- [使用](#使用)
  - [架构](#架构)
  - [读写](#读写)
  - [持久化](#持久化)
  - [集群](#集群)

# 定义 #

# 使用 #
## 架构 ##
```
概念
- 术语
  - 生产者(producer)  
    投递消息
  - 消费者(consumer)  
    接收消息  
  - 服务节点(broker)  
    存储和转发消息
  - 虚拟主机(virtual host) 
    多个用户使用同一消息队列
  - 连接(connection)
  - 信道(channel)
  - 交换器(exchange) 
    路由消息
  - 路由键(routingkey)  
    消息的路由规则
  - 绑定键(bindingkey)  
    消息绑定到队列的路由规则
  - 队列(queue)  
    存储消息
消息模型
- 简单模式(simple)
  一个生产者，一个消费者，通过队列直接消费
- 工作队列模式(work queue)
  一个生产者，多个消费者，通过队列直接消费
- 发布/订阅模式(Publish/Subscribe)
  - fanout  
    会消息路由到所有与该交换器绑定的队列中
  - direct  
    会把消息路由到BindingKey和RoutingKey完全匹配的队列中
  - topic  
    会把消息路由到BingingKey和RoutintKey模糊匹配的队列中 *匹配单个单词 #匹配多个(可以是零个)
  - headers  
    通过headers属性进行消息匹配 
    x-match all 所有都匹配 any 任意一个匹配
```

## 读写 ##
```
生产者
- 消息确认
  - 事务(同步)
  - confirms(异步)

消费者
- 消息确认
  - ack
    - 自动确认
    - 手动确认

消息
- 过期时间

队列
- 死信队列
```

## 持久化 ##
存储机制
- 持久化消息
  持久化消息在到达队列时写入磁盘，同时会内存中保存一份备份，当内存吃紧时，消息从内存中清除
- 非持久化消息
  非持久化消息一般只存于内存中，当内存吃紧时会被换入磁盘，以节省内存空间

存储结构
- 队列索引
  - rabbit_queue_index
    维护队列的落盘消息的信息，如存储地点、是否已被交付给消费者、是否已被消费者ack等  
    index使用顺序的段文件来存储，后缀为.idx，文件名从0开始累加，每个段文件中包含固定的segment_entry_count条记录，默认值是16384  
- 消息存储 
  - msg_store_persistent
  - msg_store_transient
  store使用文件来存储，后缀为.rdq，经过store处理的所有消息都会以追加的方式写入到该文件中，当该文件的大小超过指定的限制(file_size_limit)后，将会关闭该文件并创建一个新的文件以供新的消息写入。文件名从0开始进行累加。在进行消息的存储时，RabbitMQ会在ETS(Erlang Term Storage)表中记录消息在文件中的位置映射和文件的相关信息  

## 集群 ##
- 分布式集群
  - 普通模式
    每个节点都有所有队列元数据，当前节点的消息数据，队列之间通过转发获取消息
- 复制集群  
  - 镜像模式
    每个节点存储所有队列元数据，所有的消息数据

参考资料  
